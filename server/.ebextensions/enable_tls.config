#
# Based on https://gist.github.com/tony-gutierrez/198988c34e020af0192bab543d35a62a
#

container_commands:
  10_installcertbot:
    command: "wget https://dl.eff.org/certbot-auto;chmod a+x certbot-auto"
  20_getcert:
    command: "sudo ./certbot-auto certonly --debug --non-interactive --email me@djnicholson.com --agree-tos --standalone --domains server.blockslack.io --keep-until-expiring --pre-hook \"initctl stop nginx\" --post-hook \"initctl start nginx\" "
  30_link:
    command: "ln -sf /etc/letsencrypt/live/${certdomain} /etc/letsencrypt/live/ebcert"
  40_restartnginx:
    command: "sudo initctl restart nginx"

Resources:
  sslSecurityGroupIngress: 
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}
      IpProtocol: tcp
      ToPort: 443
      FromPort: 443
      CidrIp: 0.0.0.0/0

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/62_change_nginx_tls.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      echo **** Enabling TLS ****
      sudo sed -i '/\s*listen\s*8080/c \
              listen 443 default ssl;\
              ssl_certificate      /etc/letsencrypt/live/ebcert/fullchain.pem;
              ssl_certificate_key  /etc/letsencrypt/live/ebcert/privkey.pem;
              ssl_session_timeout  5m;
              ssl_protocols  TLSv1.1 TLSv1.2;
              ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
              ssl_prefer_server_ciphers   on;\
          ' /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
      echo *** Done; new file: ***
      cat /tmp/deployment/config/#etc#nginx#conf.d#00_elastic_beanstalk_proxy.conf
      echo *** End ***

packages: 
  yum:
    epel-release: [] 

